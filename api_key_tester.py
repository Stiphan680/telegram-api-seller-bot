"""\nAPI Key Tester Module\nTests API keys for validity and functionality\n"""\n\nimport requests\nimport asyncio\nfrom datetime import datetime\nfrom database import Database\nfrom config import Config\n\nclass APIKeyTester:\n    def __init__(self):\n        self.db = Database()\n        self.api_base_url = Config.API_BASE_URL\n    \n    async def test_api_key(self, api_key: str) -> dict:\n        """\n        Comprehensive API key test\n        Returns detailed test results\n        """\n        results = {\n            'valid': False,\n            'working': False,\n            'details': {},\n            'tests': {\n                'database': False,\n                'validation': False,\n                'chat': False\n            },\n            'errors': [],\n            'warnings': []\n        }\n        \n        # Test 1: Database Check\n        try:\n            key_data = self.db.validate_api_key(api_key)\n            \n            if key_data:\n                results['tests']['database'] = True\n                results['valid'] = True\n                \n                # Extract details\n                results['details'] = {\n                    'plan': key_data.get('plan', 'unknown'),\n                    'is_active': key_data.get('is_active', False),\n                    'requests_used': key_data.get('requests_used', 0),\n                    'created_at': key_data.get('created_at', 'unknown'),\n                    'expiry_date': key_data.get('expiry_date'),\n                    'telegram_id': key_data.get('telegram_id')\n                }\n                \n                # Check expiry\n                if key_data.get('expiry_date'):\n                    expiry = datetime.fromisoformat(key_data['expiry_date'])\n                    days_left = (expiry - datetime.now()).days\n                    results['details']['days_left'] = days_left\n                    results['details']['is_expired'] = days_left < 0\n                    \n                    if days_left < 0:\n                        results['errors'].append('API key has expired')\n                        results['valid'] = False\n                    elif days_left < 3:\n                        results['warnings'].append(f'API key expires in {days_left} days')\n                else:\n                    results['details']['days_left'] = None\n                    results['details']['is_expired'] = False\n                \n                # Check if active\n                if not key_data.get('is_active'):\n                    results['errors'].append('API key is deactivated')\n                    results['valid'] = False\n            else:\n                results['errors'].append('API key not found in database')\n                return results\n                \n        except Exception as e:\n            results['errors'].append(f'Database check failed: {str(e)}')\n            return results\n        \n        # Test 2: API Gateway Validation\n        if results['valid']:\n            try:\n                response = requests.post(\n                    f"{self.api_base_url}/validate",\n                    headers={"X-API-Key": api_key},\n                    timeout=10\n                )\n                \n                if response.status_code == 200:\n                    data = response.json()\n                    if data.get('valid'):\n                        results['tests']['validation'] = True\n                    else:\n                        results['errors'].append('API gateway validation failed')\n                elif response.status_code == 401:\n                    results['errors'].append('API key rejected by gateway')\n                else:\n                    results['errors'].append(f'Gateway returned status {response.status_code}')\n                    \n            except requests.exceptions.Timeout:\n                results['warnings'].append('Validation endpoint timeout')\n            except requests.exceptions.ConnectionError:\n                results['errors'].append('Cannot connect to API gateway')\n            except Exception as e:\n                results['errors'].append(f'Validation test failed: {str(e)}')\n        \n        # Test 3: Actual Chat Test\n        if results['valid'] and results['tests']['validation']:\n            try:\n                response = requests.post(\n                    f"{self.api_base_url}/chat",\n                    headers={\n                        "X-API-Key": api_key,\n                        "Content-Type": "application/json"\n                    },\n                    json={"question": "Reply with just: test successful"},\n                    timeout=30\n                )\n                \n                if response.status_code == 200:\n                    data = response.json()\n                    if data.get('success'):\n                        results['tests']['chat'] = True\n                        results['working'] = True\n                        results['details']['last_response_preview'] = data.get('response', '')[:50]\n                    else:\n                        results['errors'].append(f"Chat failed: {data.get('error', 'Unknown error')}")\n                else:\n                    results['errors'].append(f'Chat endpoint returned status {response.status_code}')\n                    \n            except requests.exceptions.Timeout:\n                results['errors'].append('Chat request timeout (>30s)')\n            except Exception as e:\n                results['errors'].append(f'Chat test failed: {str(e)}')\n        \n        return results\n    \n    def format_test_result(self, results: dict, show_details: bool = True) -> str:\n        """Format test results for Telegram message"""\n        \n        if not results['valid']:\n            message = "ğŸš« *API KEY INVALID*\\n\\n"\n            message += "âŒ Status: NOT VALID\\n\\n"\n            \n            if results['errors']:\n                message += "*Errors:*\\n"\n                for error in results['errors']:\n                    message += f"â€¢ {error}\\n"\n            \n            return message\n        \n        # Valid key - show detailed results\n        if results['working']:\n            message = "âœ… *API KEY WORKING!*\\n\\n"\n        else:\n            message = "âš ï¸ *API KEY VALID BUT NOT WORKING*\\n\\n"\n        \n        # Test Results\n        message += "*Test Results:*\\n"\n        message += f"â€¢ Database: {'âœ…' if results['tests']['database'] else 'âŒ'}\\n"\n        message += f"â€¢ Validation: {'âœ…' if results['tests']['validation'] else 'âŒ'}\\n"\n        message += f"â€¢ Chat: {'âœ…' if results['tests']['chat'] else 'âŒ'}\\n"\n        message += "\\n"\n        \n        # Details\n        if show_details and results['details']:\n            details = results['details']\n            message += "*API Key Details:*\\n"\n            \n            plan_emoji = {"free": "ğŸ†“", "basic": "ğŸ’", "pro": "â­"}.get(details.get('plan', ''), "â“")\n            message += f"â€¢ Plan: {plan_emoji} {details.get('plan', 'unknown').upper()}\\n"\n            message += f"â€¢ Requests Used: {details.get('requests_used', 0)}\\n"\n            \n            if details.get('days_left') is not None:\n                days = details['days_left']\n                if days < 0:\n                    message += f"â€¢ Status: âŒ EXPIRED\\n"\n                elif days < 3:\n                    message += f"â€¢ Expires: âš ï¸ {days} days left\\n"\n                else:\n                    message += f"â€¢ Expires: âœ… {days} days left\\n"\n            else:\n                message += "â€¢ Expiry: â™¾ï¸ No expiry (Permanent)\\n"\n            \n            message += "\\n"\n        \n        # Warnings\n        if results['warnings']:\n            message += "*Warnings:*\\n"\n            for warning in results['warnings']:\n                message += f"âš ï¸ {warning}\\n"\n            message += "\\n"\n        \n        # Errors (if any despite being valid)\n        if results['errors']:\n            message += "*Issues:*\\n"\n            for error in results['errors']:\n                message += f"âŒ {error}\\n"\n            message += "\\n"\n        \n        # Final status\n        if results['working']:\n            message += "âœ¨ *Your API key is fully functional!*"\n        elif results['valid']:\n            message += "ğŸ”§ *API key is valid but has issues. Contact support.*"\n        \n        return message\n    \n    async def quick_test(self, api_key: str) -> str:\n        """Quick test with formatted response"""\n        results = await self.test_api_key(api_key)\n        return self.format_test_result(results)\n\n\ndef get_api_key_tester():\n    """Get singleton instance"""\n    return APIKeyTester()\n