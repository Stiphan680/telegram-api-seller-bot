"""\nAPI Health Checker - Admin Tool\nComprehensive API testing and monitoring\nRun: python api_health_checker.py\n"""\n\nimport requests\nimport time\nimport json\nfrom datetime import datetime\nfrom colorama import Fore, Style, init\nfrom database import Database\nfrom config import Config\n\n# Initialize colorama for colored output\ninit(autoreset=True)\n\nclass APIHealthChecker:\n    def __init__(self):\n        self.api_base_url = Config.API_BASE_URL\n        self.db = Database()\n        self.results = {\n            'timestamp': datetime.now().isoformat(),\n            'tests_passed': 0,\n            'tests_failed': 0,\n            'warnings': [],\n            'errors': []\n        }\n    \n    def print_header(self, title):\n        """Print formatted header"""\n        print(f"\\n{Fore.CYAN}{'='*60}")\n        print(f"{Fore.CYAN}{title.center(60)}")\n        print(f"{Fore.CYAN}{'='*60}{Style.RESET_ALL}\\n")\n    \n    def print_success(self, message):\n        """Print success message"""\n        print(f"{Fore.GREEN}‚úÖ {message}{Style.RESET_ALL}")\n        self.results['tests_passed'] += 1\n    \n    def print_error(self, message):\n        """Print error message"""\n        print(f"{Fore.RED}‚ùå {message}{Style.RESET_ALL}")\n        self.results['tests_failed'] += 1\n        self.results['errors'].append(message)\n    \n    def print_warning(self, message):\n        """Print warning message"""\n        print(f"{Fore.YELLOW}‚ö†Ô∏è  {message}{Style.RESET_ALL}")\n        self.results['warnings'].append(message)\n    \n    def print_info(self, message):\n        """Print info message"""\n        print(f"{Fore.BLUE}‚ÑπÔ∏è  {message}{Style.RESET_ALL}")\n    \n    def test_api_gateway_health(self):\n        """Test 1: Check if API gateway is up"""\n        self.print_header("TEST 1: API Gateway Health Check")\n        \n        try:\n            start_time = time.time()\n            response = requests.get(f"{self.api_base_url}/health", timeout=10)\n            latency = (time.time() - start_time) * 1000\n            \n            if response.status_code == 200:\n                data = response.json()\n                self.print_success(f"API Gateway is UP (Latency: {latency:.2f}ms)")\n                self.print_info(f"Status: {data.get('status', 'unknown')}")\n                self.print_info(f"Version: {data.get('version', 'unknown')}")\n                \n                # Check features\n                features = data.get('features', [])\n                if features:\n                    self.print_info(f"Features: {', '.join(features)}")\n                \n                if latency > 3000:\n                    self.print_warning(f"High latency detected: {latency:.2f}ms")\n                \n                return True\n            else:\n                self.print_error(f"API returned status code: {response.status_code}")\n                return False\n                \n        except requests.exceptions.Timeout:\n            self.print_error("Request timeout - API not responding")\n            return False\n        except requests.exceptions.ConnectionError:\n            self.print_error("Connection error - API might be down")\n            return False\n        except Exception as e:\n            self.print_error(f"Unexpected error: {str(e)}")\n            return False\n    \n    def test_api_endpoints(self):\n        """Test 2: Test all API endpoints"""\n        self.print_header("TEST 2: API Endpoints Testing")\n        \n        endpoints = [\n            {"path": "/", "method": "GET", "name": "Home/Info"},\n            {"path": "/health", "method": "GET", "name": "Health Check"},\n        ]\n        \n        for endpoint in endpoints:\n            try:\n                url = f"{self.api_base_url}{endpoint['path']}"\n                \n                if endpoint['method'] == 'GET':\n                    response = requests.get(url, timeout=5)\n                else:\n                    response = requests.post(url, timeout=5)\n                \n                if response.status_code in [200, 401]:  # 401 is ok for auth-required endpoints\n                    self.print_success(f"{endpoint['name']}: Available")\n                else:\n                    self.print_warning(f"{endpoint['name']}: Status {response.status_code}")\n                    \n            except Exception as e:\n                self.print_error(f"{endpoint['name']}: Failed - {str(e)}")\n    \n    def test_api_key_validation(self):\n        """Test 3: Test API key validation"""\n        self.print_header("TEST 3: API Key Validation System")\n        \n        # Get a test API key from database\n        try:\n            test_key = self.db.api_keys.find_one({'is_active': True})\n            \n            if not test_key:\n                self.print_warning("No active API keys found in database")\n                return\n            \n            api_key = test_key['api_key']\n            \n            # Test validate endpoint\n            try:\n                response = requests.post(\n                    f"{self.api_base_url}/validate",\n                    headers={"X-API-Key": api_key},\n                    timeout=10\n                )\n                \n                if response.status_code == 200:\n                    data = response.json()\n                    if data.get('valid'):\n                        self.print_success(f"API Key validation working")\n                        self.print_info(f"Test Key Plan: {data.get('plan', 'N/A')}")\n                        self.print_info(f"Requests Used: {data.get('requests_used', 0)}")\n                        \n                        # Check expiry\n                        if data.get('expires_in_days') is not None:\n                            days = data['expires_in_days']\n                            if days < 7:\n                                self.print_warning(f"Test key expires in {days} days")\n                    else:\n                        self.print_error("Valid key returned invalid response")\n                else:\n                    self.print_error(f"Validation endpoint returned: {response.status_code}")\n                    \n            except Exception as e:\n                self.print_error(f"Validation test failed: {str(e)}")\n            \n            # Test with invalid key\n            try:\n                response = requests.post(\n                    f"{self.api_base_url}/validate",\n                    headers={"X-API-Key": "invalid-key-12345"},\n                    timeout=10\n                )\n                \n                if response.status_code == 401:\n                    self.print_success("Invalid key rejection working")\n                else:\n                    self.print_warning("Invalid key not properly rejected")\n                    \n            except Exception as e:\n                self.print_error(f"Invalid key test failed: {str(e)}")\n                \n        except Exception as e:\n            self.print_error(f"Database access failed: {str(e)}")\n    \n    def test_chat_endpoint(self):\n        """Test 4: Test chat functionality"""\n        self.print_header("TEST 4: Chat Endpoint Testing")\n        \n        try:\n            test_key = self.db.api_keys.find_one({'is_active': True})\n            \n            if not test_key:\n                self.print_warning("No active API keys for testing")\n                return\n            \n            api_key = test_key['api_key']\n            \n            # Test simple chat\n            test_questions = [\n                {"question": "Say 'test successful' only", "expected_type": "text"},\n            ]\n            \n            for test in test_questions:\n                try:\n                    start_time = time.time()\n                    response = requests.post(\n                        f"{self.api_base_url}/chat",\n                        headers={\n                            "X-API-Key": api_key,\n                            "Content-Type": "application/json"\n                        },\n                        json={"question": test["question"]},\n                        timeout=30\n                    )\n                    latency = (time.time() - start_time) * 1000\n                    \n                    if response.status_code == 200:\n                        data = response.json()\n                        if data.get('success'):\n                            self.print_success(f"Chat response received (Latency: {latency:.2f}ms)")\n                            self.print_info(f"Response preview: {data['response'][:80]}...")\n                            \n                            if latency > 10000:\n                                self.print_warning(f"Slow response time: {latency:.2f}ms")\n                        else:\n                            self.print_error(f"Chat failed: {data.get('error', 'Unknown')}")\n                    else:\n                        self.print_error(f"Chat returned status: {response.status_code}")\n                        \n                except requests.exceptions.Timeout:\n                    self.print_error("Chat request timeout (>30s)")\n                except Exception as e:\n                    self.print_error(f"Chat test failed: {str(e)}")\n                    \n        except Exception as e:\n            self.print_error(f"Chat endpoint test setup failed: {str(e)}")\n    \n    def test_database_connection(self):\n        """Test 5: Database connectivity and health"""\n        self.print_header("TEST 5: Database Health Check")\n        \n        try:\n            # Test connection\n            stats = self.db.get_stats()\n            \n            if stats:\n                self.print_success("Database connection working")\n                self.print_info(f"Total Users: {stats.get('total_users', 0)}")\n                self.print_info(f"Total API Keys: {stats.get('total_keys', 0)}")\n                self.print_info(f"Active Keys: {stats.get('active_keys', 0)}")\n                self.print_info(f"Total Requests: {stats.get('total_requests', 0)}")\n                \n                # Check for issues\n                if stats.get('active_keys', 0) == 0:\n                    self.print_warning("No active API keys in database")\n                \n                if stats.get('total_users', 0) == 0:\n                    self.print_warning("No users in database")\n                    \n            else:\n                self.print_error("Failed to get database stats")\n                \n        except Exception as e:\n            self.print_error(f"Database connection failed: {str(e)}")\n    \n    def test_ai_backend_status(self):\n        """Test 6: Check AI backend configuration"""\n        self.print_header("TEST 6: AI Backend Status")\n        \n        try:\n            available_backends = Config.get_available_backends()\n            \n            if available_backends:\n                self.print_success(f"Available backends: {', '.join(available_backends)}")\n                \n                # Check each backend\n                if 'perplexity' in available_backends:\n                    self.print_info("‚úì Perplexity API configured (Premium)")\n                if 'gemini' in available_backends:\n                    self.print_info("‚úì Gemini API configured (Free)")\n                if 'groq' in available_backends:\n                    self.print_info("‚úì Groq API configured (Free)")\n                    \n                self.print_info(f"Active backend mode: {Config.AI_BACKEND}")\n                \n            else:\n                self.print_error("No AI backends configured!")\n                self.print_warning("Add API keys in environment variables")\n                \n        except Exception as e:\n            self.print_error(f"Backend check failed: {str(e)}")\n    \n    def test_rate_limits(self):\n        """Test 7: Check rate limit configuration"""\n        self.print_header("TEST 7: Rate Limit Configuration")\n        \n        try:\n            self.print_success("Rate limits configured:")\n            self.print_info(f"Free Plan: {Config.RATE_LIMIT_FREE} req/min")\n            self.print_info(f"Basic Plan: {Config.RATE_LIMIT_BASIC} req/min")\n            self.print_info(f"Pro Plan: {Config.RATE_LIMIT_PRO} req/min")\n            \n            # Validate limits\n            if Config.RATE_LIMIT_FREE > 20:\n                self.print_warning("Free plan limit seems high")\n            \n        except Exception as e:\n            self.print_error(f"Rate limit check failed: {str(e)}")\n    \n    def check_expiring_keys(self):\n        """Test 8: Check for expiring API keys"""\n        self.print_header("TEST 8: Expiring API Keys Check")\n        \n        try:\n            from datetime import timedelta\n            \n            warning_threshold = datetime.now() + timedelta(days=7)\n            \n            expiring_keys = list(self.db.api_keys.find({\n                'is_active': True,\n                'expiry_date': {'$ne': None, '$lte': warning_threshold.isoformat()}\n            }))\n            \n            if expiring_keys:\n                self.print_warning(f"Found {len(expiring_keys)} keys expiring within 7 days")\n                \n                for key in expiring_keys[:5]:  # Show first 5\n                    expiry = datetime.fromisoformat(key['expiry_date'])\n                    days_left = (expiry - datetime.now()).days\n                    self.print_info(f"User {key['telegram_id']} ({key['plan']}): {days_left} days left")\n                    \n                if len(expiring_keys) > 5:\n                    self.print_info(f"... and {len(expiring_keys) - 5} more")\n            else:\n                self.print_success("No keys expiring soon")\n                \n        except Exception as e:\n            self.print_error(f"Expiry check failed: {str(e)}")\n    \n    def generate_summary(self):\n        """Generate final summary"""\n        self.print_header("HEALTH CHECK SUMMARY")\n        \n        total_tests = self.results['tests_passed'] + self.results['tests_failed']\n        success_rate = (self.results['tests_passed'] / total_tests * 100) if total_tests > 0 else 0\n        \n        print(f"\\n{Fore.CYAN}Tests Run: {total_tests}")\n        print(f"{Fore.GREEN}Passed: {self.results['tests_passed']}")\n        print(f"{Fore.RED}Failed: {self.results['tests_failed']}")\n        print(f"{Fore.YELLOW}Warnings: {len(self.results['warnings'])}")\n        print(f"\\n{Fore.CYAN}Success Rate: {success_rate:.1f}%{Style.RESET_ALL}\\n")\n        \n        # Overall status\n        if self.results['tests_failed'] == 0:\n            print(f"{Fore.GREEN}{'='*60}")\n            print(f"{Fore.GREEN}‚úÖ SYSTEM STATUS: HEALTHY".center(60))\n            print(f"{Fore.GREEN}{'='*60}{Style.RESET_ALL}\\n")\n        elif self.results['tests_failed'] <= 2:\n            print(f"{Fore.YELLOW}{'='*60}")\n            print(f"{Fore.YELLOW}‚ö†Ô∏è  SYSTEM STATUS: DEGRADED".center(60))\n            print(f"{Fore.YELLOW}{'='*60}{Style.RESET_ALL}\\n")\n        else:\n            print(f"{Fore.RED}{'='*60}")\n            print(f"{Fore.RED}‚ùå SYSTEM STATUS: CRITICAL".center(60))\n            print(f"{Fore.RED}{'='*60}{Style.RESET_ALL}\\n")\n        \n        # Show critical errors\n        if self.results['errors']:\n            print(f"{Fore.RED}Critical Issues:{Style.RESET_ALL}")\n            for error in self.results['errors']:\n                print(f"  ‚Ä¢ {error}")\n            print()\n        \n        # Show warnings\n        if self.results['warnings']:\n            print(f"{Fore.YELLOW}Warnings:{Style.RESET_ALL}")\n            for warning in self.results['warnings'][:5]:\n                print(f"  ‚Ä¢ {warning}")\n            if len(self.results['warnings']) > 5:\n                print(f"  ... and {len(self.results['warnings']) - 5} more")\n            print()\n        \n        print(f"{Fore.BLUE}Report generated: {self.results['timestamp']}{Style.RESET_ALL}\\n")\n    \n    def save_report(self):\n        """Save report to file"""\n        filename = f"health_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"\n        \n        with open(filename, 'w') as f:\n            json.dump(self.results, f, indent=2)\n        \n        print(f"{Fore.BLUE}üìÑ Report saved: {filename}{Style.RESET_ALL}\\n")\n    \n    def run_all_tests(self):\n        """Run all health checks"""\n        print(f"\\n{Fore.MAGENTA}{'='*60}")\n        print(f"{Fore.MAGENTA}üè• API HEALTH CHECKER - ADMIN TOOL".center(60))\n        print(f"{Fore.MAGENTA}{'='*60}{Style.RESET_ALL}")\n        print(f"{Fore.CYAN}Started: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}{Style.RESET_ALL}\\n")\n        \n        # Run all tests\n        self.test_database_connection()\n        self.test_ai_backend_status()\n        self.test_api_gateway_health()\n        self.test_api_endpoints()\n        self.test_api_key_validation()\n        self.test_chat_endpoint()\n        self.test_rate_limits()\n        self.check_expiring_keys()\n        \n        # Generate summary\n        self.generate_summary()\n        \n        # Save report\n        self.save_report()\n\n\ndef main():\n    """Main entry point"""\n    checker = APIHealthChecker()\n    checker.run_all_tests()\n\n\nif __name__ == "__main__":\n    # Check if colorama is installed\n    try:\n        import colorama\n    except ImportError:\n        print("Installing colorama for colored output...")\n        import subprocess\n        subprocess.check_call(["pip", "install", "colorama"])\n        import colorama\n    \n    main()\n